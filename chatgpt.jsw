import OpenAI from "openai";
import { secrets } from 'wix-secrets-backend';

const assistantId = await secrets.get('assistant_key');

const openai = new OpenAI({
    apiKey: await secrets.get('openai_api_key');,
});

export async function createThread() {
    try {
        const thread = await openai.beta.threads.create();
        return thread;
    } catch (error) {
        console.error("Error creating thread:", error);
        throw error;
    }
}

export async function addUserMessageToThread(threadId, userMessage) {
    try {
        const message = await openai.beta.threads.messages.create(
            threadId, {
                role: "user",
                content: userMessage
            }
        );
        return message
    } catch (error) {
        console.error("Error in addUserMessageToThread:", error);
        throw error;
    }
}

export async function runModel(threadId) {
    try {
        let run = await openai.beta.threads.runs.createAndPoll(
            threadId, {
                assistant_id: assistantId,
            }
        );

        if (run.status === 'completed') {
            const messages = await openai.beta.threads.messages.list(run.thread_id);

            if (messages && messages.data.length > 0) {
                return {
                    success: true,
                    response: messages.data[0].content[0].text.value
                };
            } else {
                return {
                    success: false,
                    error: 'No messages found in the thread.'
                };
            }

        } else {
            return {
                success: false,
                error: `Run status: ${run.status}`
            };
        }

    } catch (error) {
        console.error("Error in runModel:", error);

        return {
            success: false,
            error: `An unexpected error occurred: ${error.message}`
        };
    }
}